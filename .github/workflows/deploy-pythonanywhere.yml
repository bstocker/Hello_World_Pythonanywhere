name: Deploy to PythonAnywhere (recursive upload)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          : "${{ secrets.PA_USERNAME }}"
          : "${{ secrets.PA_TOKEN }}"
          : "${{ secrets.PA_TARGET_DIR }}"
          : "${{ secrets.PA_WEBAPP_DOMAIN }}"

      - name: Upload all files recursively (dirs auto-created by Files API)
        shell: bash
        run: |
          set -euo pipefail
          USER="${{ secrets.PA_USERNAME }}"
          TOKEN="${{ secrets.PA_TOKEN }}"
          TARGET_DIR="${{ secrets.PA_TARGET_DIR }}"
          DOMAIN="${{ secrets.PA_WEBAPP_DOMAIN }}"

          # Optional: set PA_HOST secret to "eu.pythonanywhere.com" if your account is on EU.
          HOST="${{ secrets.PA_HOST }}"
          if [[ -z "${HOST}" ]]; then HOST="www.pythonanywhere.com"; fi

          echo "Using PythonAnywhere host: ${HOST}"
          echo "Target directory: ${TARGET_DIR}"

          # Upload every file; remote directories are created automatically by the Files API.
          while IFS= read -r -d '' file; do
            rel="${file#./}"

            # Exclusions (adjust to taste)
            case "$rel" in
              .git/*|.github/*|.venv/*|__pycache__/*|node_modules/*) continue ;;
              *.pyc|.DS_Store) continue ;;
            esac

            remote_path="${TARGET_DIR}/${rel}"
            echo " - ${rel} -> ${remote_path}"

            curl -sS --fail -X POST \
              -H "Authorization: Token ${TOKEN}" \
              -F "content=@${file}" \
              "https://${HOST}/api/v0/user/${USER}/files/path${remote_path}" \
              >/dev/null

          done < <(
            find . \
              -type d \( -name .git -o -name .github -o -name .venv -o -name __pycache__ -o -name node_modules \) -prune -false \
              -o -type f \
                ! -name ".DS_Store" \
                ! -name "*.pyc" \
                -print0
          )

          echo "Reloading webapp ${DOMAIN}..."
          curl -sS --fail -X POST \
            -H "Authorization: Token ${TOKEN}" \
            "https://${HOST}/api/v0/user/${USER}/webapps/${DOMAIN}/reload/" \
            >/dev/null

          echo "Deployed. Try: https://${DOMAIN}/"
